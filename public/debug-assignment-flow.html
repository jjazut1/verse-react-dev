<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assignment Link Flow Debug</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    .debug-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #007bff;
    }
    .error-section {
      border-left-color: #dc3545;
      background: #fff5f5;
    }
    .success-section {
      border-left-color: #28a745;
      background: #f0fff4;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    .log {
      background: #f1f3f4;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    .status {
      padding: 8px 12px;
      border-radius: 4px;
      font-weight: bold;
      margin: 5px 0;
    }
    .status.pending { background: #fff3cd; color: #856404; }
    .status.success { background: #d1ecf1; color: #0c5460; }
    .status.error { background: #f8d7da; color: #721c24; }
    input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 5px;
      width: 300px;
    }
  </style>
</head>
<body>
  <h1>üîç Assignment Link Flow Debugger</h1>
  
  <div class="debug-section">
    <h2>Step 1: Test Token Access</h2>
    <p>Test if accessing a play URL with token properly triggers the game loading:</p>
    
    <div>
      <label>Test Token:</label>
      <input type="text" id="testToken" value="test-assignment-123" placeholder="Enter token to test">
      <button onclick="testTokenAccess()">Test Token Access</button>
    </div>
    
    <div id="tokenTestResult" class="log"></div>
  </div>
  
  <div class="debug-section">
    <h2>Step 2: PWA Deep Link Flow</h2>
    <p>Simulate the full PWA deep link restoration process:</p>
    
    <button onclick="simulatePWAFlow()">Simulate PWA Flow</button>
    <button onclick="simulateEmailLink()">Simulate Email Link Click</button>
    
    <div id="pwaFlowResult" class="log"></div>
  </div>
  
  <div class="debug-section">
    <h2>Step 3: GameByToken Component Debug</h2>
    <p>Check if the GameByToken component is loading and processing tokens correctly:</p>
    
    <button onclick="testGameByTokenFlow()">Test GameByToken Flow</button>
    <button onclick="checkGameTypeMapping()">Check Game Type Mapping</button>
    
    <div id="gameTokenResult" class="log"></div>
  </div>
  
  <div class="debug-section">
    <h2>Live Debug Console</h2>
    <p>Real-time debugging information from the app:</p>
    
    <button onclick="startLiveDebug()">Start Live Debug</button>
    <button onclick="stopLiveDebug()">Stop</button>
    <button onclick="clearLogs()">Clear Logs</button>
    
    <div id="liveDebugLog" class="log" style="max-height: 400px;"></div>
  </div>

  <script>
    let debugInterval = null;
    let originalConsoleLog = console.log;
    let originalConsoleError = console.error;
    let originalConsoleWarn = console.warn;
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logMessage = `[${timestamp}] ${message}`;
      console.log(logMessage);
      
      // Also display in our debug log
      const debugLog = document.getElementById('liveDebugLog');
      if (debugLog) {
        debugLog.textContent += logMessage + '\n';
        debugLog.scrollTop = debugLog.scrollHeight;
      }
    }
    
    function testTokenAccess() {
      const token = document.getElementById('testToken').value;
      const resultDiv = document.getElementById('tokenTestResult');
      
      if (!token) {
        resultDiv.textContent = 'Please enter a token to test.';
        return;
      }
      
      resultDiv.textContent = 'Testing token access...\n';
      
      // Test 1: Direct URL access
      const testUrl = `/play?token=${token}`;
      log(`Testing direct access to: ${testUrl}`);
      
      // Test 2: Check if URL would trigger token detection
      const urlParams = new URLSearchParams(`?token=${token}`);
      const hasToken = urlParams.get('token');
      
      resultDiv.textContent += `‚úì Token extracted from URL: ${hasToken}\n`;
      
      // Test 3: Check deep link storage
      localStorage.setItem('deepLinkParams', `?token=${token}`);
      const stored = localStorage.getItem('deepLinkParams');
      resultDiv.textContent += `‚úì Deep link storage test: ${stored}\n`;
      
      // Test 4: Check token parsing from stored params
      const storedParams = new URLSearchParams(stored);
      const parsedToken = storedParams.get('token');
      resultDiv.textContent += `‚úì Token parsing from storage: ${parsedToken}\n`;
      
      if (parsedToken === token) {
        resultDiv.textContent += `‚úì SUCCESS: Token flow working correctly\n`;
      } else {
        resultDiv.textContent += `‚ùå ERROR: Token mismatch in flow\n`;
      }
      
      // Test 5: Simulate navigation
      const targetUrl = `/play?token=${parsedToken}`;
      resultDiv.textContent += `‚úì Would navigate to: ${targetUrl}\n`;
      
      // Cleanup
      localStorage.removeItem('deepLinkParams');
    }
    
    function simulatePWAFlow() {
      const resultDiv = document.getElementById('pwaFlowResult');
      resultDiv.textContent = 'Simulating PWA flow...\n';
      
      const token = document.getElementById('testToken').value || 'test-123';
      
      // Step 1: Simulate email link click
      resultDiv.textContent += `Step 1: Email link clicked - /play?token=${token}\n`;
      
      // Step 2: PWA detection (simulate)
      const isPWAInstalled = window.matchMedia('(display-mode: standalone)').matches;
      resultDiv.textContent += `Step 2: PWA detected: ${isPWAInstalled}\n`;
      
      // Step 3: Deep link storage
      localStorage.setItem('deepLinkParams', `?token=${token}`);
      resultDiv.textContent += `Step 3: Stored deep link params\n`;
      
      // Step 4: Simulate PWA launch (redirect to start_url)
      resultDiv.textContent += `Step 4: PWA opens at start_url: /student\n`;
      
      // Step 5: Simulate restoration logic
      const savedParams = localStorage.getItem('deepLinkParams');
      if (savedParams) {
        const urlParams = new URLSearchParams(savedParams);
        const savedToken = urlParams.get('token');
        
        if (savedToken) {
          const targetUrl = `/play?token=${savedToken}`;
          resultDiv.textContent += `Step 5: ‚úì Token detected, navigating to: ${targetUrl}\n`;
          resultDiv.textContent += `‚úì SUCCESS: PWA flow completed successfully\n`;
        } else {
          resultDiv.textContent += `Step 5: ‚ùå No token found in saved params\n`;
        }
      } else {
        resultDiv.textContent += `Step 5: ‚ùå No saved params found\n`;
      }
      
      // Cleanup
      localStorage.removeItem('deepLinkParams');
    }
    
    function simulateEmailLink() {
      const token = document.getElementById('testToken').value || 'test-123';
      const emailUrl = `/launch.html?target=${encodeURIComponent('/play')}&token=${token}`;
      
      const resultDiv = document.getElementById('pwaFlowResult');
      resultDiv.textContent += `\nSimulating email link: ${emailUrl}\n`;
      resultDiv.textContent += `This would go through launch.html interceptor\n`;
      
      log(`Email link simulation: ${emailUrl}`);
    }
    
    function testGameByTokenFlow() {
      const resultDiv = document.getElementById('gameTokenResult');
      resultDiv.textContent = 'Testing GameByToken component flow...\n';
      
      const token = document.getElementById('testToken').value || 'test-123';
      
      // Test URL parameter extraction
      const testSearchParams = new URLSearchParams(`?token=${token}`);
      const extractedToken = testSearchParams.get('token');
      resultDiv.textContent += `‚úì URL parameter extraction: ${extractedToken}\n`;
      
      // Test email link access detection
      const hasToken = !!extractedToken;
      resultDiv.textContent += `‚úì Token presence triggers email link access: ${hasToken}\n`;
      
      // Test session storage flags
      if (hasToken) {
        sessionStorage.setItem('direct_token_access', 'true');
        const flag = sessionStorage.getItem('direct_token_access');
        resultDiv.textContent += `‚úì Direct access flag set: ${flag}\n`;
      }
      
      resultDiv.textContent += `‚úì Component should auto-start game for email links\n`;
      
      // Cleanup
      sessionStorage.removeItem('direct_token_access');
    }
    
    function checkGameTypeMapping() {
      const resultDiv = document.getElementById('gameTokenResult');
      resultDiv.textContent += '\nChecking game type mapping...\n';
      
      const gameTypes = [
        'sentence-sense',
        'place-value-showdown', 
        'whack-a-mole',
        'spinner-wheel',
        'anagram',
        'sort-categories-egg-reveal'
      ];
      
      gameTypes.forEach(type => {
        resultDiv.textContent += `‚úì Game type supported: ${type}\n`;
      });
      
      resultDiv.textContent += `Note: Fixed 'sort-categories-egg' -> 'sentence-sense'\n`;
    }
    
    function startLiveDebug() {
      if (debugInterval) {
        stopLiveDebug();
      }
      
      log('Starting live debug monitoring...');
      
      // Intercept console logs
      console.log = function(...args) {
        const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
        if (message.includes('GameByToken') || message.includes('PWA') || message.includes('token')) {
          log(`LOG: ${message}`, 'info');
        }
        originalConsoleLog.apply(console, args);
      };
      
      console.error = function(...args) {
        const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
        log(`ERROR: ${message}`, 'error');
        originalConsoleError.apply(console, args);
      };
      
      console.warn = function(...args) {
        const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
        log(`WARN: ${message}`, 'warn');
        originalConsoleWarn.apply(console, args);
      };
      
      // Monitor for navigation
      const originalPushState = history.pushState;
      const originalReplaceState = history.replaceState;
      
      history.pushState = function(...args) {
        log(`NAVIGATION: pushState to ${args[2]}`);
        return originalPushState.apply(history, args);
      };
      
      history.replaceState = function(...args) {
        log(`NAVIGATION: replaceState to ${args[2]}`);
        return originalReplaceState.apply(history, args);
      };
    }
    
    function stopLiveDebug() {
      if (debugInterval) {
        clearInterval(debugInterval);
        debugInterval = null;
      }
      
      // Restore console
      console.log = originalConsoleLog;
      console.error = originalConsoleError;
      console.warn = originalConsoleWarn;
      
      log('Live debug monitoring stopped.');
    }
    
    function clearLogs() {
      document.getElementById('liveDebugLog').textContent = '';
    }
    
    // Auto-start with basic environment info
    window.addEventListener('load', () => {
      log('Debug page loaded');
      log(`Current URL: ${window.location.href}`);
      log(`PWA mode: ${window.matchMedia('(display-mode: standalone)').matches}`);
      log(`Has service worker: ${'serviceWorker' in navigator}`);
      
      // Show any stored debug data
      const storedParams = localStorage.getItem('deepLinkParams');
      if (storedParams) {
        log(`Found stored deep link params: ${storedParams}`);
      }
      
      const directAccess = sessionStorage.getItem('direct_token_access');
      if (directAccess) {
        log(`Direct access flag: ${directAccess}`);
      }
    });
  </script>
</body>
</html> 