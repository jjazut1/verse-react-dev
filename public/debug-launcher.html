<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Launcher</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #000;
            color: #0f0;
        }
        .log {
            margin: 5px 0;
            padding: 5px;
            border: 1px solid #333;
        }
        .step {
            background: #001100;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #0f0;
        }
    </style>
</head>
<body>
    <h1>üîç DEBUG LAUNCHER</h1>
    <div id="logs"></div>
    
    <script>
        function log(message) {
            console.log('[DEBUG-LAUNCHER] ' + message);
            const div = document.createElement('div');
            div.className = 'log';
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            document.getElementById('logs').appendChild(div);
        }
        
        function step(message) {
            console.log('[DEBUG-LAUNCHER STEP] ' + message);
            const div = document.createElement('div');
            div.className = 'step';
            div.innerHTML = '<strong>' + message + '</strong>';
            document.getElementById('logs').appendChild(div);
        }
        
        step('1. Debug launcher loaded!');
        log('URL: ' + window.location.href);
        
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        const target = params.get('target');
        
        step('2. Parameters parsed');
        log('Token: ' + token);
        log('Target: ' + target);
        
        step('3. Checking PWA context');
        log('Standalone mode: ' + window.matchMedia('(display-mode: standalone)').matches);
        log('Navigator standalone: ' + window.navigator.standalone);
        log('Service worker available: ' + ('serviceWorker' in navigator));
        
        if ('serviceWorker' in navigator) {
            log('SW controller: ' + (navigator.serviceWorker.controller ? 'Available' : 'Not available'));
            
            navigator.serviceWorker.getRegistrations().then(regs => {
                log('SW registrations: ' + regs.length);
            });
        }
        
        step('4. Checking for existing PWA clients');
        
        // Try the focus existing PWA logic
        if (navigator.serviceWorker.controller) {
            log('Attempting to communicate with service worker...');
            
            const message = {
                type: 'FOCUS_EXISTING_PWA',
                url: window.location.origin + '/play?token=' + encodeURIComponent(token) + '&pwa=true&from=debug-launcher',
                token: token
            };
            
            log('Sending message: ' + JSON.stringify(message));
            
            navigator.serviceWorker.addEventListener('message', (event) => {
                log('Received SW message: ' + JSON.stringify(event.data));
                
                if (event.data && event.data.type === 'NAVIGATE_TO_ASSIGNMENT_ACK') {
                    if (event.data.success) {
                        step('SUCCESS: Existing PWA found and focused!');
                        log('Closing debug launcher...');
                        setTimeout(() => window.close(), 2000);
                    } else {
                        step('FALLBACK: No existing PWA found');
                        log('Will redirect to new window in 3 seconds...');
                        setTimeout(() => {
                            const redirectUrl = window.location.origin + '/play?token=' + encodeURIComponent(token) + '&pwa=true&from=debug-launcher';
                            log('Redirecting to: ' + redirectUrl);
                            window.location.href = redirectUrl;
                        }, 3000);
                    }
                }
            });
            
            navigator.serviceWorker.controller.postMessage(message);
            log('Message sent to service worker');
            
            // Timeout fallback
            setTimeout(() => {
                step('TIMEOUT: No response from service worker');
                log('Falling back to direct redirect in 2 seconds...');
                setTimeout(() => {
                    const redirectUrl = window.location.origin + '/play?token=' + encodeURIComponent(token) + '&pwa=true&from=debug-launcher';
                    log('Redirecting to: ' + redirectUrl);
                    window.location.href = redirectUrl;
                }, 2000);
            }, 5000);
            
        } else {
            step('NO SERVICE WORKER CONTROLLER');
            log('Redirecting directly to app in 3 seconds...');
            setTimeout(() => {
                const redirectUrl = window.location.origin + '/play?token=' + encodeURIComponent(token) + '&pwa=true&from=debug-launcher';
                log('Redirecting to: ' + redirectUrl);
                window.location.href = redirectUrl;
            }, 3000);
        }
    </script>
</body>
</html> 