rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isTeacher() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
    }
    
    // Allow anyone to read high scores
    match /highScores/{highScoreId} {
      allow read: if true;
      allow create: if 
        // Basic field validation
        request.resource.data.playerName is string &&
        request.resource.data.playerName.size() >= 3 &&
        request.resource.data.playerName.size() <= 12 &&
        request.resource.data.playerName.matches('^[A-Za-z0-9\\s]+$') &&
        
        // Profanity check (case-insensitive)
        !request.resource.data.playerName.lower().matches('.*\\b(ass|fuck|shit|damn|bitch|crap|piss|dick|cock|pussy|whore|slut|bastard)\\b.*') &&
        
        // Score validation
        request.resource.data.score is number &&
        request.resource.data.score >= 0 &&
        request.resource.data.score <= 1000 &&
        request.resource.data.configId is string &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.gameType is string &&
        
        // Game config validation
        exists(/databases/$(database)/documents/userGameConfigs/$(request.resource.data.configId)) &&
        get(/databases/$(database)/documents/userGameConfigs/$(request.resource.data.configId)).data.share == true &&
        get(/databases/$(database)/documents/userGameConfigs/$(request.resource.data.configId)).data.type == request.resource.data.gameType;
    }

    function isValidPlayerName(name) {
      // Only allow alphanumeric characters and spaces
      let nameRegex = "[A-Za-z0-9\\s]+";
      return name.matches(nameRegex);
    }
    
    // Games collection
    match /games/{gameId} {
      allow read: if true;
      allow create, update, delete: if isTeacher();
    }
    
    // Game configurations collection (admin only)
    match /gameConfigs/{configId} {
      allow read: if true;
      allow write: if false;
    }
    
    // User-created game configurations
    match /userGameConfigs/{configId} {
      allow read: if true;
      allow create: if 
        isAuthenticated() &&
        // Basic field validation
        (
          // Sort Categories Egg game validation
          (request.resource.data.type == 'sort-categories-egg' &&
          request.resource.data.title is string &&
          request.resource.data.title.size() > 0 &&
          request.resource.data.eggQty is number &&
          request.resource.data.eggQty > 0 &&
          request.resource.data.categories is list &&
          request.resource.data.categories.size() > 0) ||
          
          // Simple Whack-a-mole validation
          (request.resource.data.type == 'whack-a-mole' &&
          request.resource.data.title is string &&
          request.resource.data.categories is list)
        ) &&
        // Common fields validation
        request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
    }
    
    // Assignments collection
    match /assignments/{assignmentId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isTeacher();
    }
    
    // Teachers collection
    match /teachers/{teacherId} {
      allow read: if true;
      allow write: if false;
    }
    
    // Sort Categories Egg collection
    match /sortCategoriesEgg/{configId} {
      allow read: if true;
      allow create, update, delete: if true;
    }

    // Blank Game Templates collection
    match /blankGameTemplates/{templateId} {
      allow read: if true;
      allow write: if false;
    }
    
    // Category Templates collection - NEW RULE
    match /categoryTemplates/{templateId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
    }
  }
} 